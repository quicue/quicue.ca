# CAB Report Generation Pipeline
#
# Generates human-readable reports for CAB review sessions.
# Includes change summary, impact analysis, and deployment runbook.
#
# Usage:
#   include:
#     - project: 'quicue/quicue-cab'
#       file: '/gitlab/cab-reports.yml'
#
#   reports:
#     extends: .cab-generate-reports
#     variables:
#       CUE_PATH: "."
#       GRAPH_EXPR: "infra"

.cab-generate-reports:
  image: cuelang/cue:latest
  stage: build
  variables:
    CUE_PATH: "."
    GRAPH_EXPR: "infra"
    OUTPUT_DIR: "artifacts/reports"
    CAB_CONFIG_EXPR: "cabConfig"
  script:
    - |
      echo "=== CAB Report Generation ==="
      mkdir -p ${OUTPUT_DIR}

      DATE=$(date -u +%Y-%m-%d)
      TIME=$(date -u +%H:%M:%S)

      # Change report
      echo "--- Generating Change Report ---"
      cue eval ${CUE_PATH} -e "
        import \"quicue.ca/cab/reports\"

        _report: reports.#ChangeReport & {
          Current: ${GRAPH_EXPR}
          Config: ${CAB_CONFIG_EXPR}
        }

        _report.markdown
      " --out text | sed "s/{{.GeneratedAt}}/${DATE} ${TIME}/g" > ${OUTPUT_DIR}/change-report.md

      # Impact report for critical resources
      echo "--- Generating Impact Report ---"
      cue eval ${CUE_PATH} -e "
        import \"quicue.ca/cab/reports\"
        import \"quicue.ca@v0:patterns\"

        _graph: patterns.#InfraGraph & {Input: ${GRAPH_EXPR}}
        _report: reports.#ImpactReport & {
          Graph: _graph
          Config: ${CAB_CONFIG_EXPR}
        }

        _report.markdown
      " --out text > ${OUTPUT_DIR}/impact-report.md

      # Deployment runbook
      echo "--- Generating Deployment Runbook ---"
      cue eval ${CUE_PATH} -e "
        import \"quicue.ca/cab/reports\"
        import \"quicue.ca@v0:patterns\"

        _graph: patterns.#InfraGraph & {Input: ${GRAPH_EXPR}}
        _report: reports.#DeploymentRunbook & {
          Graph: _graph
          Config: ${CAB_CONFIG_EXPR}
        }

        _report.markdown
      " --out text > ${OUTPUT_DIR}/deployment-runbook.md

      # Rollback plan
      echo "--- Generating Rollback Plan ---"
      cue eval ${CUE_PATH} -e "
        import \"quicue.ca/cab/reports\"
        import \"quicue.ca@v0:patterns\"

        _graph: patterns.#InfraGraph & {Input: ${GRAPH_EXPR}}
        _report: reports.#RollbackPlan & {
          Graph: _graph
          Config: ${CAB_CONFIG_EXPR}
        }

        _report.markdown
      " --out text > ${OUTPUT_DIR}/rollback-plan.md

      # Summary for quick review
      echo "--- Generating CAB Summary ---"
      cat > ${OUTPUT_DIR}/cab-summary.md << SUMMARY
      # CAB Review Package

      **Generated**: ${DATE} ${TIME}
      **Commit**: ${CI_COMMIT_SHA}
      **Branch**: ${CI_COMMIT_REF_NAME}

      ## Reports Included

      - [Change Report](change-report.md)
      - [Impact Report](impact-report.md)
      - [Deployment Runbook](deployment-runbook.md)
      - [Rollback Plan](rollback-plan.md)

      ## Quick Stats

      $(cue eval ${CUE_PATH} -e "
        import \"quicue.ca@v0:patterns\"
        _graph: patterns.#InfraGraph & {Input: ${GRAPH_EXPR}}
        \"- Total Resources: \\(_graph.metrics.total_resources)\\n- Max Depth: \\(_graph.metrics.max_depth)\\n- Root Services: \\(len(_graph.roots))\"
      " --out text)

      ---
      *Generated by quicue-cab*
      SUMMARY

      echo ""
      echo "--- Generated Reports ---"
      ls -la ${OUTPUT_DIR}/
  artifacts:
    paths:
      - ${OUTPUT_DIR}/
    expire_in: 30 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"

# Generate reports with diff from previous tag
.cab-generate-diff-reports:
  extends: .cab-generate-reports
  variables:
    PREVIOUS_TAG: ""  # e.g., "cab/2026-01-08"
  script:
    - |
      mkdir -p ${OUTPUT_DIR}

      if [ -n "${PREVIOUS_TAG}" ]; then
        echo "Comparing against: ${PREVIOUS_TAG}"
        git show ${PREVIOUS_TAG}:graph.json > /tmp/previous-graph.json 2>/dev/null || echo "{}" > /tmp/previous-graph.json

        # Generate diff report
        cue eval ${CUE_PATH} -e "
          import \"quicue.ca/cab/reports\"

          _report: reports.#DiffReport & {
            SourceName: \"${PREVIOUS_TAG}\"
            TargetName: \"current\"
            Source: $(cat /tmp/previous-graph.json)
            Target: ${GRAPH_EXPR}
          }

          _report.markdown
        " --out text > ${OUTPUT_DIR}/diff-report.md
      fi
