# Multi-Source Reconciliation Example

Demonstrates the **"Sources OBSERVE, Resolutions DECIDE"** pattern for unifying
data from N independent source systems into a single typed model.

## The Pattern

Each source system writes its own fields into a shared `#VM` struct.
CUE's lattice unification merges them automatically — no custom merge logic needed.

```
Source Alpha (hypervisor)    → _in_alpha: true, alpha_ip: "...", cpus: 4, ...
Source Bravo (asset CMDB)    → _in_bravo: true, bravo_ip: "...", location: "DC-East", ...
Source Charlie (dependencies) → _in_charlie: true, charlie_ip: "...", appears_in_count: 8, ...
                                        ↓
                              CUE unifies into one struct per VM
                                        ↓
                              Projections surface gaps, conflicts, risk
```

**Why this works:** Each source owns its own IP field and boolean marker. No two sources
write the same mutable field, so CUE never produces a unification conflict (`_|_`).

## Files

| File | Purpose |
|------|---------|
| `schema.cue` | `#VM` type definition — the contract all sources conform to |
| `alpha.cue` | Source A: 12 VMs from hypervisor inventory (authority 1) |
| `bravo.cue` | Source B: 12 VMs from asset management CMDB (authority 2) |
| `charlie.cue` | Source C: 8 VMs from dependency graph (authority 3) |
| `resolutions.cue` | IP conflict resolution by authority hierarchy |
| `proj_gap.cue` | Gap report: which sources have which VMs |
| `proj_conflicts.cue` | IP conflict detection across sources |
| `proj_sources.cue` | Per-VM source attribution (exposes hidden `_in_*` fields) |
| `proj_spof.cue` | SPOF detection combining dependencies + placement |

## Quick Start

```bash
# Validate the unified model
cue vet -c ./examples/reconciliation/

# Gap report summary
cue export ./examples/reconciliation/ -e gap_report.summary --out json

# IP conflicts
cue export ./examples/reconciliation/ -e ip_conflicts --out json

# Source attribution per VM
cue export ./examples/reconciliation/ -e vm_sources --out json

# Single points of failure
cue export ./examples/reconciliation/ -e spof --out json
```

## Expected Output

```json
// gap_report.summary
{
  "total": 15,
  "in_all_three": 7,
  "in_two_sources": 3,
  "in_one_source": 5,
  "missing_alpha": 3,
  "missing_bravo": 3,
  "missing_charlie": 7
}
```

## Adapting for Your Environment

1. **Copy this directory** into your project
2. **Rename sources** to match your systems (e.g., `vcenter.cue`, `servicenow.cue`, `netbox.cue`)
3. **Edit `#VM` schema** — add/remove fields per source
4. **Write a normalizer** — Python/Go script that reads your source exports and generates `.cue` files
5. **Add projections** — gap reports, conflict detection, capacity planning, SPOF analysis

The authority hierarchy in `resolutions.cue` is typically auto-generated by the normalizer.
