# GitLab CI template for CUE validation
# Include in your .gitlab-ci.yml:
#   include:
#     - remote: 'https://raw.githubusercontent.com/quicue/quicue-ci/main/gitlab/cue-validate.yml'

.cue-validate:
  image: golang:1.21-alpine
  stage: validate
  variables:
    CUE_VERSION: "0.15.4"
    CUE_PATH: "./..."
    CUE_FLAGS: ""
  before_script:
    - |
      if [ ! -f /usr/local/bin/cue ]; then
        apk add --no-cache curl
        curl -sSL "https://github.com/cue-lang/cue/releases/download/v${CUE_VERSION}/cue_v${CUE_VERSION}_linux_amd64.tar.gz" | tar xz -C /usr/local/bin
      fi
  script:
    - cue version
    - cue vet ${CUE_FLAGS} ${CUE_PATH}
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Concrete validation job (use directly or extend)
cue:validate:
  extends: .cue-validate
  variables:
    CUE_PATH: "./..."

# Strict validation (requires all fields to be concrete)
.cue-validate-concrete:
  extends: .cue-validate
  variables:
    CUE_FLAGS: "-c"

