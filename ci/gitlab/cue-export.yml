# GitLab CI template for CUE export
# Include in your .gitlab-ci.yml:
#   include:
#     - remote: 'https://raw.githubusercontent.com/quicue/quicue-ci/main/gitlab/cue-export.yml'

.cue-export:
  image: golang:1.21-alpine
  stage: build
  variables:
    CUE_VERSION: "0.15.4"
    CUE_PATH: "."
    CUE_EXPR: ""
    CUE_FORMAT: "json"
    OUTPUT_FILE: "output.${CUE_FORMAT}"
  before_script:
    - |
      if [ ! -f /usr/local/bin/cue ]; then
        apk add --no-cache curl
        curl -sSL "https://github.com/cue-lang/cue/releases/download/v${CUE_VERSION}/cue_v${CUE_VERSION}_linux_amd64.tar.gz" | tar xz -C /usr/local/bin
      fi
  script:
    - |
      if [ -n "${CUE_EXPR}" ]; then
        cue export ${CUE_PATH} -e ${CUE_EXPR} --out ${CUE_FORMAT} > ${OUTPUT_FILE}
      else
        cue export ${CUE_PATH} --out ${CUE_FORMAT} > ${OUTPUT_FILE}
      fi
    - cat ${OUTPUT_FILE}
  artifacts:
    paths:
      - ${OUTPUT_FILE}
    expire_in: 1 week

# Export to JSON
.cue-export-json:
  extends: .cue-export
  variables:
    CUE_FORMAT: "json"
    OUTPUT_FILE: "output.json"

# Export to YAML
.cue-export-yaml:
  extends: .cue-export
  variables:
    CUE_FORMAT: "yaml"
    OUTPUT_FILE: "output.yaml"

# Export multiple expressions
.cue-export-multi:
  image: golang:1.21-alpine
  stage: build
  variables:
    CUE_VERSION: "0.15.4"
    CUE_PATH: "."
    CUE_FORMAT: "json"
  before_script:
    - |
      if [ ! -f /usr/local/bin/cue ]; then
        apk add --no-cache curl
        curl -sSL "https://github.com/cue-lang/cue/releases/download/v${CUE_VERSION}/cue_v${CUE_VERSION}_linux_amd64.tar.gz" | tar xz -C /usr/local/bin
      fi
  script:
    - mkdir -p exports
    - |
      for expr in ${CUE_EXPRESSIONS}; do
        cue export ${CUE_PATH} -e ${expr} --out ${CUE_FORMAT} > exports/${expr}.${CUE_FORMAT}
      done
  artifacts:
    paths:
      - exports/
    expire_in: 1 week
